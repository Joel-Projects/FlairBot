{% extends "base.html" %}
{% block breadCrumbs %}
    <!--suppress HtmlUnknownTarget -->
    <li class="breadcrumb-item"><a href={{ url_for('removalReason.root') }}>Reasons</a></li>
{% endblock %}
{% block activeItem %}active item{% endblock %}
{% block content %}
    <!--suppress ALL -->
    <style>
        .tooltip-inner {
            max-width: 250px;
        }
    </style>
    <style>
        .btn-primary {
            display: inline-block;
            float: left;
        {#min-height: 54px;#}
        }

        .btn-success {
            display: inline-block;
            float: left;
        {#vertical-align: top;#} margin-left: 10px;
        {#min-height: 54px;#}{#border: 1px solid black;#}
        }

        .btn-danger {
            display: inline-block;
            float: left;
        {#vertical-align: top;#} margin-left: 10px;
        {#min-height: 54px;#}{#border: 1px solid black;#}
        }
    </style>
    <script>
        $(function () {
            $(function () {
                let form = document.getElementById('createRemovalReasonForm');
                let commentToggle = document.getElementById('commentToggle');
                let banToggle = document.getElementById('banToggle');
                let banGroup = document.getElementById('banGroup');
                let commentEntry = document.getElementById('commentEntry');
                let commentInput = document.getElementById('commentinput');
                commentEntry.hidden = !commentToggle.checked;
                commentInput.required = commentToggle.checked;
                banGroup.hidden = !banToggle.checked;

                $("#removal_reasons").tablesorter({
                    theme: "bootstrap",
                    cancelSelection: false,
                    sortReset: true
                });

                $('[data-toggle="tooltip"]').tooltip();

                $('#reasonCreate').click(function () {
                    let subreddit = document.getElementById('subreddit');
                    let subredditFeedback = document.getElementById('subredditFeedback');
                    let botAccount = document.getElementById('bot_account');
                    let bot_accountFeedback = document.getElementById('bot_accountFeedback');
                    let commentToggle = document.getElementById('commentToggle');
                    let commentInput = document.getElementById('commentInput');
                    let enableOnAdd = document.getElementById('enableOnAdd');

                    if (form.checkValidity()) {
                        $('#reasonCreate').prop('disabled', true);
                        $('#reasonCreate').html('<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>Adding...');
                        $.ajax({
                            data: {
                                subreddit: subreddit.value,
                                bot_account: botAccount.value,
                                webhook_type: webhookType.value,
                                webhook: webhookurl.value,
                                commentToggle: commentToggle.checked,
                                footerToggle: footerToggle.checked,
                                header: commentInput.value,
                                footer: footerinput.value,
                                enable: enableOnAdd.checked
                            },
                            type: 'POST',
                            url: '/api/reason/add'
                        })
                            .done(function (data) {
                                console.log(data);
                                if (!data.validSubreddit) {
                                    subreddit.className = "form-control is-invalid";
                                    subredditFeedback.innerText = "That subreddit doesn't exist!"
                                    $('#reasonCreate').prop('disabled', false);
                                    $('#reasonCreate').prop('class', 'btn btn-primary');
                                    $('#reasonCreate').html('Add');
                                } else if (data.subredditExists) {
                                    subreddit.className = "form-control is-invalid";
                                    subredditFeedback.innerText = "That subreddit already exists!"
                                    $('#reasonCreate').prop('disabled', false);
                                    $('#reasonCreate').prop('class', 'btn btn-primary');
                                    $('#reasonCreate').html('Add');
                                }
                                if (!data.validRedditor) {
                                    botAccount.className = "form-control is-invalid";
                                    bot_accountFeedback.innerText = "That redditor doesn't exist!"
                                    $('#reasonCreate').prop('disabled', false);
                                    $('#reasonCreate').prop('class', 'btn btn-primary');
                                    $('#reasonCreate').html('Add');
                                }
                                if (data.validSubreddit && !data.subredditExists && data.validRedditor) {
                                    let subredditsTable = document.getElementById('subreddits');
                                    let row = subredditsTable.insertRow();
                                    let subredditName = row.insertCell();
                                    subredditName.innerHTML = data.subreddit.subreddit;
                                    let bot_account = row.insertCell();
                                    bot_account.innerHTML = data.subreddit.bot_account;
                                    let removalReasonCount = row.insertCell();
                                    let webhook_type = row.insertCell();
                                    if (data.subreddit.webhook_type) {
                                        webhookType = data.subreddit.webhook_type;
                                    } else {
                                        webhookType = 'None';
                                    }
                                    webhook_type.innerHTML = webhookType;
                                    let enabled = row.insertCell();
                                    if (data.subreddit.enabled) {
                                        buttonType = 'danger';
                                        enableButtonStatus = 'Disable';
                                        toggleState = false
                                    } else {
                                        buttonType = 'success';
                                        enableButtonStatus = 'Enable';
                                        toggleState = true
                                    }
                                    enabled.innerHTML = "<button class=\"btn btn-" + buttonType + "\" id=" + data.subreddit.subreddit + "_toggle onclick=\"toggleSubreddit('" + data.subreddit.subreddit + "', " + toggleState + ")\">" + enableButtonStatus + "</button>";
                                    let edit = row.insertCell();
                                    edit.innerHTML = "<a href=\"/subreddits/" + data.subreddit.subreddit + "\" class=\"btn btn-primary\">Edit</a>";
                                    $('#reasonCreate').html('Added');
                                    $('#newSubredditModal').modal('hide');
                                    $('#reasonCreate').prop('disabled', false);
                                    $('#reasonCreate').prop('class', 'btn btn-primary');
                                    $('#reasonCreate').html('Add');
                                }
                                popNotification(data.success, data.error);
                            });
                    }
                });

                $("#commentToggle").click(function () {
                    commentEntry.hidden = !commentToggle.checked;
                    commentInput.required = commentToggle.checked;
                    commentInput.style.minHeight = '54px'
                });
                $("#banToggle").click(function () {
                    banGroup.hidden = !commentToggle.checked;
                    commentInput.required = commentToggle.checked;
                    commentInput.style.minHeight = '54px'
                });

            });
    </script>
    <script>
        $(document).ready(function () {
            $('[data-toggle="tooltip"]').tooltip();
        });
    </script>
    <body>
    <div class="container">
        <form id="createRemovalReasonForm">
            <div class="form-group">
                <div class="col-lg-8">
                    <label class="control-label" for="subreddit">Subreddit</label>
                    <div class="subName" id="subName">
                        <div class="input-group mb-2">
                            <div class="input-group-prepend" id="subredditPrepend">
                                <span class="input-group-text">/r/</span>
                            </div>
                            <select class="custom-select" id="subreddit">
                                <option selected="">Select Subreddit</option>
                                {% for subreddit in subreddits %}
                                    <option value="{{ subreddit.subreddit }}">{{ subreddit.subreddit }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="flair_text">Flair Text</label>
                        <div class="botAccount" id="botAccount">
                            <div class="input-group mb-3">
                                <input class="form-control" id="flair_text" name="flairText" placeholder="The flair the bot will look for" required>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label id="flair_description" for="description">Description</label>
                    <input type="text" value="" name="flairDescription" class="form-control" id="description" placeholder="Descripton that will be logged in selected destination">
                </div>
                <div class="form-group">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="lockToggle" name="lockToggle">
                        <label class="custom-control-label" for="lockToggle">Lock</label>
                        <small id="lockHelp" class="form-text text-muted">Lock removed post's comments</small>
                    </div>
                </div>
                <div class="form-group">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="commentLockToggle" name="commentLockToggle">
                        <label class="custom-control-label" for="commentLockToggle">Lock Removal Comment</label>
                        <small id="commentLockHelp" class="form-text text-muted">Disable replies to removal comment</small>
                    </div>
                </div>
                <div class="form-group">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="banToggle" name="banToggle" checked>
                        <label class="custom-control-label" for="banToggle">Ban</label>
                        <small id="banHelp" class="form-text text-muted">Ban user of removed post</small>
                    </div>
                </div>
                <div class="col-lg-8" id="banGroup">
                    <div class="form-group">
                        <label id="ban_duration_label" for="ban_duration">Ban Duration (Days - 0 for permaban)</label>
                        <input class="form-control" type="number" name="ban_duration" pattern="[0-9]*" id="ban_duration" inputmode="tel" value="0">
                    </div>
                    <div class="form-group">
                        <label for="ban_reason">Ban Reason</label>
                        <input type="text" value="" name="ban_reason" class="form-control" id="ban_reason" placeholder="Subreddit/site rule broken or other.">
                    </div>
                    <div class="form-group">
                        <label for="ban_message">Ban Message</label>
                        <input type="text" value="" name="ban_message" class="form-control" id="ban_message" placeholder="Message sent to the user">
                    </div>
                    <div class="form-group">
                        <label id="ban_note" for="ban_note">Ban Note</label>
                        <input type="text" value="" name="ban_note" class="form-control" id="ban_note" placeholder="Private mod note">
                    </div>
                </div>
                <div class="form-group">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="usernoteToggle" name="usernoteToggle">
                        <label class="custom-control-label" for="usernoteToggle">User note</label>
                        <small id="usernoteHelp" class="form-text text-muted">Create User note on user of removed post</small>
                    </div>
                </div>
                <div class="form-group">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="commentToggle" name="commentToggle" checked>
                        <label class="custom-control-label" for="commentToggle">Comment</label>
                        <small id="headerHelp" class="form-text text-muted">Have the bot leave a removal comment</small>
                    </div>
                </div>
                <div data-class="form-group" id="commentEntry" data-name="Comment" data-nameLower="comment" data-previewName="Comment Preview" data-formName="commentText" data-placeholder="Removal Reason Comment..."></div>

                <div class="modal-footer">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="enableOnAdd" name="enableToggle">
                        <label class="custom-control-label" for="enableOnAdd">Enable</label>
                        <small id="enableOnAddHelp" class="form-text text-muted">Enable reason on add</small>
                    </div>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" name="submit" class="btn btn-primary" id="reasonCreateNew">Add and New</button>
                    <button type="submit" name="submit" class="btn btn-primary" id="reasonCreate">Add</button>
                </div>
            </div>
        </form>
    </div>
    <script src="../static/dist/bundle.js" type="text/javascript"></script>
        {% if subreddit.enabled %}
            <button class="btn btn-danger" id="{{ reason.id }}_toggle" onclick="toggleSubreddit('{{ reason.id }}', false)" data-target="">Disable</button>
        {% else %}
            <button class="btn btn-success" id="{{ reason.id }}_toggle" onclick="toggleSubreddit('{{ reason.id }}', true)" data-target="">Enable</button>
        {% endif %}
        <button class="btn btn-danger" id="delete" data-toggle="modal" data-target="#confirmationModal">Delete Subreddit</button>
        <div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmationModalLabel">Confirmation</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    </div>
                    <div class="modal-body">Are you <strong>sure</strong> you want to delete this reason?</div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-danger" data-dismiss="modal" id="deleteConfirm">Delete this subreddit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="../static/dist/bundle.js" type="text/javascript"></script>
    </body>
{% endblock %}